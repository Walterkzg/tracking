{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">ğŸš— è½¦è¾†åˆ†æè¿›åº¦ - {{ process_id[:8] }}</h3>
        </div>
        <div class="card-body">
            <div id="progress-section">
                <div class="progress mb-3" style="height: 25px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped" role="progressbar"
                        style="width: 0%">0%</div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">è¿›å…¥è½¦è¾†</div>
                            <ul id="enter-list" class="list-group list-group-flush"></ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">ç¦»å¼€è½¦è¾†</div>
                            <ul id="exit-list" class="list-group list-group-flush"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="result-section" class="mt-4" style="display: none;">
                <div class="alert alert-success">
                    åˆ†æå®Œæˆï¼<a href="{{ url_for('download', process_id=process_id) }}" class="alert-link">ç‚¹å‡»ä¸‹è½½ç»“æœè§†é¢‘</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const processId = "{{ process_id }}";
        const updateProgress = () => {
            fetch(`/progress/${processId}`)
                .then(res => res.json())
                .then(data => {
                    // æ›´æ–°è¿›åº¦æ¡
                    const progressBar = document.getElementById('progress-bar');
                    progressBar.style.width = `${data.progress}%`;
                    progressBar.textContent = `${data.progress}%`;

                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    const updateList = (selector, items) => {
                        const list = document.querySelector(selector);
                        list.innerHTML = Object.entries(items)
                            .map(([name, count]) => `
                            <li class="list-group-item d-flex justify-content-between">
                                <span>${name}</span>
                                <span class="badge bg-primary rounded-pill">${count}</span>
                            </li>
                        `).join('');
                    };

                    updateList('#enter-list', data.counters.enter);
                    updateList('#exit-list', data.counters.exit);

                    // å¤„ç†å®Œæˆæ˜¾ç¤ºç»“æœ
                    if (data.ready) {
                        document.getElementById('result-section').style.display = 'block';
                    } else {
                        setTimeout(updateProgress, 2000);
                    }
                });
        };
        updateProgress();
    });
</script>
{% endblock %}